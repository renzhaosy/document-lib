# 宏观下的浏览器工作原理 -- 浏览器架构篇

## 前言

开篇词： `参透了浏览器的工作原理，你就能解决80%的前端难题`。

一名合格的前端工程师，掌握一定的浏览器相关知识是必备的。重点是希望通过浏览器原理的学习，能够把网络、页面渲染、JavaScript 执行流程、web 安全等等，一个前端工程师需要的知识体系搭建起来。

> 文中大部分内容来源于整理学习[极客时间-浏览器工作原理与实践](https://time.geekbang.org/column/intro/216)

## 浏览器架构

### 进程和线程

#### 什么是并行处理

计算机中的并行处理就是同一时刻处理多个任务。

比如计算下面这三个表达式的值，并显示出结果。

```js
A = 1 + 2;
B = 20 / 5;
C = 7 * 8;
```

正常情况下程序可以使用单线程来处理，分四步按顺序分别执行：

- 任务 1 是计算 A=1+2；
- 任务 2 是计算 B=20/5；
- 任务 3 是计算 C=7\*8；
- 任务 4 是显示最后计算的结果。

那如果采用`多线程`呢？

只需两个步骤：

- 第一步，使用三个线程同时执行前三个任务；
- 第二步，再执行第四个显示任务。

通过上边的对比分析，就会发现`使用并行处理能大大提升性能`。

#### 线程 VS 进程

多线程可以并行处理任务，但是`线程是不能单独存在的，它是由进程来启动和管理的`。

`一个进程就是一个程序的运行实例`。详细解释就是，启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，我们把这样的一个运行环境叫`进程`。

![单线程与多线程的进程对比图](https://image.cdn.renzhaosy.cn/post/xianchengduibi.png)

图中可以看到，`线程依附于进程，而进程中使用多线程并行处理能提高运算效率`。

总结来说，进程和线程之间的关系有一下 4 个特点：

1. 进程中的任意一线程执行出错，都会导致整个进程的崩溃。
2. 线程之间共享进程中的数据。
   ![线程之间共享进程中的数据示意图](https://image.cdn.renzhaosy.cn/post/gongxianshuju.png)
   从上图可以看出，线程 1、线程 2、线程 3 分别把执行的结果写入 A、B、C 中，然后线程 2 继续从 A、B、C 中读取数据，用来显示执行结果。
3. 当一个进程关闭之后，操作系统会回收进程所占用的内存。
4. 进程之间的内容相互隔离。

### 单进程浏览器时代

`单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程里`，包括了网络、插件、JavaScript 运行环境、渲染引擎和页面等。

单进程浏览器的架构如下如所示：

这么多的功能模块运行在一个进程里， 是导致单进程浏览器`不稳定`、`不流畅`和`不安全`的主要因素。

#### 不稳定

- 早起浏览器借助插件实现视频、游戏等强大功能，插件不稳定，一个`插件`的意外崩溃会引起整个浏览器额崩溃
- `渲染引擎模块`也不稳定，一些复杂的 JavaScript 代码有可能引起渲染引擎模块崩溃，也会导致整个浏览器崩溃。

#### 不流畅

所有页面的渲染模块、JavaScript 执行环境以及插件都是运行在同一个线程中，意味着同一时刻只能有一个模块执行。比如一个无限循环的脚本就会独占真个线程，导致其他模块不会被执行，导致浏览器失去响应。
除了`脚本`或者`插件`外，`页面的内存泄露`也是变慢的一个主要原因。

#### 不安全

- 通过`插件`可以获取系统的任意资源，也可以释放病毒、窃取账号等
- `页面脚本`可以通过浏览器的漏洞来获取系统权限。

### 多进程浏览器时代

#### 早期多进程架构

先看看下边这张图，2008 年 Chrome 发布时的进程架构。

从图中看出，Chrome 的页面运行在单独的渲染进程中，同时页面里的插件也运行在单独的插件进程中，而进程之间通过 IPC 机制进行通信（图中虚线部分）。

**如何解决不稳定问题**。由于进程是相互隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前页面进程或者插件进程，并不会影响到浏览器和其他页面。也就完美解决了`页面`或`插件`崩溃导致的整个浏览器崩溃。

**如何解决不流畅问题**。同样，JavaScript 运行在渲染进程中，所以即使 JavaScript 阻塞了渲染进程，影响到的也只是当前的渲染页面，而不会影响浏览器和其他页面。

**如何解决安全问题** 采用多新城架构的额外好处是可以使用`安全沙箱`。可以把沙箱看成是操作系统给进程上了一把锁，沙箱里面的程序可以运行，但是不能再硬盘上写入任何数据，也不能再敏感位置读取任何数据，例如你的文档和桌面。Chrome 把插件进程和渲染进程锁在沙箱里，这样就防止了上边的两个安全问题的产生。

#### 目前多进程架构

最新的 Chrome 进程架构，参考下图：

图中可以看出，最新的 Chrome 浏览器包括： 1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程。

下面分析下这几个进程的功能。

- **浏览器进程**。主要负责界面显示、用户交互、子进程管理，同事提供存储等功能。
- **渲染进程**。核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，`排版引擎Blink`和`JavaScript引擎V8`都是运行在改进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在`沙箱模式下`。
- **GPU 进程**。GPU 的初衷是为了实现 3D CSS 的效果，随后网页、Chrome 的 UI 界面都采用 GPU 来绘制。Chrome 在其多进程架构上也引入了 GPU 进程。
- **网络进程**。主要负责页面的网络资源加载，之前作为一个模块运行在浏览器进程中，直到最近才单独出来，成为一个单独进程。
- **插件进程**。主要负责插件的运行，因为插件容易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

多进程模型提高了浏览器的稳定性、流畅性和安全性，但同样带来一些问题：

- **更高的资源占用**。每个进程都会包含公共基础结构的副本（如 JavaScript 运行环境），也就意味着浏览器会消耗更多的内存资源。
- **更复杂的体系架构**。浏览器各个模块之前耦合性高、扩展性差等问题，会导致现在架构已经很难适应新的需求。

#### 未来面向服务的架构

为了解决上面的问题，Chrome 团队一直在寻求一种弹性方案，既可以解决资源占用高的问题，也可以解决复杂的体系架构的问题。

在 2016 年，Chrome 官方团队使用`“面向服务的架构”`（Services Oriented Architecture，简称 SOA）的思想设计了新的 Chrome 架构

Chrome 最终要把 UI、数据库、文件、设备、网络等模块重构为基础服务，类似操作系统底层服务，下面是 Chrome“面向服务的架构”的进程模型图：

### 总结

- 最初的浏览器都是单进程，它们不稳定、不流畅且不安全
- 早期多进程架构： 1 个 Browser 主进程、多个渲染进程、多个插件进程
- 现在多进程架构：1 个 Browser 主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程
- 未来面向服务的架构

### Q & A

### Chrome 打开一个 tab 页面需要启动多少进程？

至少包含 4 个进程： 1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、1 个渲染进程。

还会有下边的情况：

- 如果有插件的话，还会有多个插件进程。
- 页面中有 iframe 的话，iframe 会在单独的进程中。
- 如果从一个页面打开了新页面，而且两个页面属于同一个站点，新页面会复用父页面的渲染进程。
- 如果你装了扩展的话，扩展也会占用进程。

这些进程都可以通过 chrome 的任务管理器来查看。

### 即使是如今的多进程架构，偶尔还会碰到一些由于单个页面卡死最终崩溃导致所有页面崩溃的情况，请问这是什么原因呢？

Chrome 的默认策略是，每个标签对应一个渲染进程。但是如果从一个页面打开了新页面，而新页面和当前页面属于同一站点时，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫 process-per-site-instance。

直白讲，就是如果几个页面符合同一站点，那他们将被分配到一个渲染进程里边。所以，这种情况下，一个页面崩溃了，会导致同一站点的页面同时崩溃，因为他们使用了同一个渲染进程。

`同一站点`定义为根域名（例如，geekbang.org）加上协议（例如，https:// 或者http://），还包含了该根域名下的所有子域名和不同的端口，比如下面这三个：

https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080

为什么要让他们跑在一个进程里面呢？

因为在一个渲染进程里面，他们就会共享 JS 的执行环境，也就是说 A 页面可以直接在 B 页面中执行脚本。因为是同一家的站点，所以是有这个需求的。
