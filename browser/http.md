# 宏观下的浏览器工作原理 -- HTTP 请求篇

上篇宏观的介绍了浏览器，了解到了进程、线程和浏览器的架构。

那么从键入一个 URL 到展示一个页面中间又发生了什么呢？
先来看看浏览器是如何发起 HTTP 请求的。

**HTTP 是一种允许浏览器向服务器获取资源的协议，是 Web 的基础。** 所以掌握 HTTP 的知识是身为前端必不可少的知识。

首先来介绍一下网络分层 和 TCP/IP

## TCP/IP 和分层

TCP/IP 是互联网相关的各类协议族的总称。

TCP/IP 协议族中重要的一点就是分层。按照层次分别分为以下 4 层： 应用层、传输层、网络层、和数据链路层。

![TCP/IP 分层](https://image.cdn.renzhaosy.cn/http/page18image54004576.jpg)

## HTTP 报文的构成

用于 HTTP 协议交互的信息被称为 HTTP 报文。客户端的 HTTP 报文叫请求报文，服务端的叫响应报文。报文本省是有多行数据构成的字符串文本。

![请求报文和响应报文](https://image.cdn.renzhaosy.cn/http/page50image54415840.jpg)

请求报文：

- 请求行： 包含了请求方法、请求 URI 和 HTTP 版本协议
- 请求头（首部字段）： 包含表示请求的各种条件和属性的各类首部。
- 空行： CR + LF
- 请求体（报文主体）： 应该被发送的数据

响应报文包括：

- 响应行（状态行）： 包含 HTTP 版本协议、状态码
- 响应头（首部字段）：包含表示请求的各种条件和属性的各类首部，包含了服务器自身的一些信息以及服务器要在客户端保存的 Cookie 等信息。
- 空行： CR + LF
- 响应体（报文主体）： 应该被发送的数据

## 浏览器端发起 HTTP 请求流程

你可能有过以下的疑问：

1. 为什么通常在第一次访问一个站点时，打开速度很慢，当再次访问这个站点时，速度就很快了？
2. 当登录过一个网站之后，下次再访问该站点，就已经处于登录状态了，这是怎么做到的呢？

浏览器地址栏中输入 `http://renzhaosy.cn/`,那接下来浏览器会做哪些动作？

### 1. 构建请求

首先，浏览器构建请求行信息，构件好后，浏览器准备发起网络请求。

```http
GET /index.html HTTP1.1
```

### 2. 查找缓存

在真正发起请求之前，浏览器会现在浏览器缓存中查询是否有要请求的文件。其中，**浏览器缓存是一种在本地保存资源副本，以供下次请求时直接使用的技术。**

当浏览器发现缓存中存在请求的资源的副本，浏览器会拦截请求，返回该资源的副本，并直接结束请求。
好处：

- 缓解服务器端眼里，提升性能
- 对网站来说，缓存是实现快速资源加载的重要组成部分

当缓存查找失败，就会进入网络请求过程。

浏览器资源缓存又分为了**强缓存**和**协商缓存**，这里不会具体展开，请参考缓存。

### 3. 准备 IP 地址和端口

数据包是通过 IP 地址传输给接收方的。由于 IP 地址是数字表示，难以记忆，但是使用域名就好记多了，所以基于这个需求就出现了一个服务，负责把域名和 IP 地址做一一映射。**这套域名映射为 IP 的系统就叫做`域名系统`**， 简称**DNS**(Domain Name System)

- 浏览器会查找本地的**DNS 数据缓存服务**中是否有解析结果
- 如若缓存中没有则会请求 DNS 返回域名对应的 IP

拿到 IP 之后，就是获取端口号了，通常情况下，URL 没有特别指明端口号，默认是 80 端口。

> 网络的 的 七层分层

### 4. 等待 TCP 队列

IP 和端口都准备好之后，那么下一步是不是可以建立 TCP 连接了呢？

答案依然是`不行`。Chrome 有个机制，同一个域名同事最多只能建立 6 个 TCP 连接，如果同一个域名下同时有 10 个请求发生，那么其中 4 个请求会进入排队等待的状态，直至进行中的请求完成。

### 5. TCP 链接

浏览器使用**HTTP 协议作为应用层协议**，用来封装请求的文本信息；并**使用 TCP/IP 作为传输层协议**将它发到网络上。也就是说 HTTP 内容是通过 TCP 来传输数据的。在 HTTP 工作开始之前，浏览器通过 TCP 和服务器建立连接。

### 6. 发送 HTTP 请求

一旦建立了 TCP 连接，浏览器就可以和服务器进行通信了。
请求信息请看

### 7. 服务器处理 HTTP 请求流程

#### 1. 返回请求

一旦服务器处理结束，便可以返回数据给浏览器。可以通过 curl 来查看返回的数据

```shell
# -i 返回响应行、响应头和响应体的数据
curl -i https
```

```shell
HTTP/1.1 200 OK
Date: Mon, 10 Aug 2020 07:18:18 GMT
Content-Type: text/html; charset=utf-8
Transfer-Encoding: chunked
Content-Length: 25116
Connection: keep-alive

<html lang="en">
<head></head>
<body>

</body>
</html>
```

#### 2. 断开连接

通常情况下，一旦服务器向客户端返回了请求数据，它就会关闭 TCP 连接。不过如果头部中加入了

```
Connection: keep-alive
```

那么 TCP 连接在发送后仍然保持打开状态，这样浏览器就可以复用一个 TCP 连接发送请求。**保持 TCP 连接可以省去下次请求时建立连接所需的时间，提升资源加载速度。**

#### 3. 重定向

这里请求流程要结束了，不过还有一种情况需要了解，就是**重定向**。

当响应行返回来的状态码是 301 或者 3xx 时，就是告诉浏览器需要重定向到另外一个网址。而需要重定向的地址包含在响应头的 Location 字段中。

#### Q & A

##### 1. 为什么很多站点第二次打开速度会很快？

如果第二次页面打开很快，主要原因是第一次记在页面过程中，缓存了一些耗时的数据。

那么，哪些数据会被缓存呢？根据上面介绍的整体流程。**DNS 缓存**和**页面资源缓存**会被浏览器缓存。其中 DNS 缓存比较简单，它主要是在浏览器本地把对应的 IP 和域名关联起来。

重点是浏览器资源缓存。

##### 2. 登录状态是如何保持的？

**HTTP 是无状态协议**，不会对请求和响应之前的通信状态进行保存。每个请求都是分隔的，并不会保存之前一切请求或响应的信息，互不影响。那么浏览器是如何保持登录状态的呢？

请求服务端的登录之后，服务端会发送头部带有`Set-Cookie`字段的响应，浏览器会将该字段内容保存在本地。下次请求时，浏览器会自动在请求头中加入 Cookie 值。服务器端发现客户端发送的 Cookie 后，就会根据 session 得到该用户的状态信息。

## 参考

- [极客时间-浏览器工作原理与实践](https://time.geekbang.org/column/intro/216)
- 《HTTP 图解》
